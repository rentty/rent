<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>地区找房检索</title>
    <link rel="stylesheet" href="https://cache.amap.com/lbs/static/main1119.css"/>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style type="text/css">

    </style>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=5c11ae578c1dcee5ca73646f3c6c7fb7&plugin=AMap.DistrictSearch"></script>
    <script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
</head>
<body>
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
<div id="app">
    <div id="container" >

    </div>

</div>

<script>

    var vue =  new Vue({
        el: '#app',
        data: function() {
            return {
                visible: false,

            }
        },
        methods: {
            create:function(){
                console.log(total);
                if(total == 1){
                    this.boolLe  = true;
                    this.boolRe  = true;
                }
            }

        },

        watch: {

        }

    })
</script>
<script type="text/javascript">
    var houseData;
    $.ajax({
        url:'http://localhost:8080/admin/user/getMapHouseAndRent?type=-1&ori=-1&area1=-1&area2=-1&layer=-1&rent1=-1&rent2=-1&renttype=-1',//地址
        type:'POST',//类型
        //请求成功
        success:function(data){
            console.log(data);
            houseData = data;
            updateBtn(houseData.data.number);
        }
    })

    function updateBtn(val) {
        var textGr = map.getAllOverlays('Text');
        for(var i = 0;i<textGr.length;i++){
            //console.log(val[textGr[i].Je.text]);
            if(val[textGr[i].Je.text] == null){
                textGr[i].setText(textGr[i].Je.text + "<br>" + 0);
            }else {
                textGr[i].setText(textGr[i].Je.text + "<br>" +val[textGr[i].Je.text]);
            }
        }
        //console.log(textGr);
    }
</script>
<script type="text/javascript">

    var city = "广州";
    var cityLng ;
    var markers = [];
    var overlayGroups = new AMap.OverlayGroup(markers);
    var mapOpts = {
        showIndoorMap: false, // 是否在有矢量底图的时候自动展示室内地图，PC默认true,移动端默认false
        resizeEnable: true, //是否监控地图容器尺寸变化，默认值为false
        dragEnable: true, // 地图是否可通过鼠标拖拽平移，默认为true
        keyboardEnable: false, //地图是否可通过键盘控制，默认为true
        doubleClickZoom: false, // 地图是否可通过双击鼠标放大地图，默认为true
        zoomEnable: true, //地图是否可缩放，默认值为true
        rotateEnable: false, // 地图是否可旋转，3D视图默认为true，2D视图默认false
    }
    var map = new AMap.Map("container", mapOpts);

    /*AMap.plugin(['DistrictSearch','AMap.Driving'],function(){//异步同时加载多个插件
        var DistrictSearch = new AMap.DistrictSearch();
        map.addControl(DistrictSearch);
        var driving = new AMap.Driving();//驾车路线规划
        driving.search(/!*参数*!/)
    });*/

    //行政区划查询、加按钮点击事件、画边界（隐藏）
    var district = new AMap.DistrictSearch({
        level:"city",
        showbiz:false,
        extensions:"all",
        subdistrict:1,
    });//注意：需要使用插件同步下发功能才能这样直接使用(或在申请key值哪里加 &plugin=AMap.DistrictSearch )
    district.search(city, function(status, result) {
        if(status=='complete') {
            console.log(result);
            var bounds = result.districtList[0].boundaries;
            cityLng = [result.districtList[0].center.lng,result.districtList[0].center.lat];
            //console.log(cityLng);
            //画出城市级边界
            if (bounds) {
                for (var i = 0, l = bounds.length; i < l; i++) {
                    var polygonAll = new AMap.Polygon({
                        map: map,
                        strokeWeight: 5,
                        strokeColor: '#0091ea',
                        fillColor: '#80d8ff',
                        fillOpacity: 0.2,
                        path: bounds[i]
                    });
                    polygonAll.setExtData("123");
                }
            }
            //区域文本按钮
            var list = result.districtList[0].districtList;
            for(var i = 0;i < list.length ;i++){
                // 创建纯文本标记


                var text = new AMap.Text({
                    text:list[i].name,
                    anchor:'center', // 设置文本标记锚点
                    cursor:'pointer',
                    /*animation:"AMAP_ANIMATION_DROP",*/
                    style:{
                        'padding': '0.25rem 0.25rem',
                        'margin-bottom': '1rem',
                        'border-radius': '.50rem',
                        'background-color': '#1C86EE',
                       /* 'width': '15rem',*/
                        'border-width': 0,
                        'box-shadow': '0 2px 6px 0 rgba(114, 124, 245, .5)',
                        'text-align': 'center',
                        'font-size': '16px',
                        'color': 'white'
                    },
                    position: [list[i].center.lng,list[i].center.lat]
                });
                text.setMap(map);
                text.on('click', dirClick);

                //画处所有区级边界
                district.search(list[i].name, function(status, result) {
                    //console.log(list);
                    //console.log(result);
                    if (status == 'complete') {
                        //var polList = [];
                        var bounds = result.districtList[0].boundaries;
                       if(bounds) {
                           for (var j = 0; j < bounds.length; j++) {
                               //var num = j;
                               var polygon = new AMap.Polygon({
                                   map: map,
                                   strokeWeight: 5,
                                   strokeColor: '#0091ea',
                                   fillColor: '#80d8ff',
                                   fillOpacity: 0.2,
                                   path: bounds[j]
                               });
                           }
                           polygon.setExtData(result.districtList[0].name);
                       }
                        map.setZoomAndCenter(13, [result.districtList[0].center.lng,result.districtList[0].center.lat]);
                    }
                });
            }
            map.setZoomAndCenter(11, cityLng);
        }
    });

    //点击区域按钮
    function dirClick(val) {
        console.log(overlayGroups);
        map.remove(overlayGroups);
        markers = [];
        //console.log(map.getAllOverlays('polygon'));
        var list = map.getAllOverlays('polygon');
        var pol;
        for(var i = 0;i < list.length;i++){
            //console.log(list[i].Je.extData);
            //console.log(val.target.B.text);
            if(list[i].Je.extData == val.target.B.text){
                pol = list[i];
                list[i].show();
                map.setZoomAndCenter(14,
                    [val.lnglat.lng,val.lnglat.lat]);
            }else {
                list[i].hide();
            }
        }
        //显示区域内的房屋标点
        var list = houseData.data.MapHouse;
        for(var i = 0;i < list.length;i++){
            if(pol.contains([list[i].hsLongitude,list[i].hsLatitude])){
                //console.log(i);
                /*var marker = new AMap.Marker({
                    position: [list[i].hsLongitude,list[i].hsLatitude],
                    icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    extData: {
                        name: list[i].hsId
                    }
                });*/
                var text = new AMap.Text({
                    text:"$"+list[i].rtlfRent,
                    anchor:'center', // 设置文本标记锚点
                    cursor:'pointer',
                    /*animation:"AMAP_ANIMATION_DROP",*/
                    style:{
                        'padding': '0.25rem 0.25rem',
                        'margin-bottom': '1rem',
                        'border-radius': '.50rem',
                        'background-color': '#EEAD0E',
                        /* 'width': '15rem',*/
                        'border-width': 0,
                        'box-shadow': '0 2px 6px 0 rgba(114, 124, 245, .5)',
                        'text-align': 'center',
                        'font-size': '16px',
                        'color': 'white',
                       /* 'animation':'AMAP_ANIMATION_DROP',*/
                    },
                    position: [list[i].hsLongitude,list[i].hsLatitude]
                });
                //鼠标移过事件
                var content = [];
                content.push("面积："+list[i].hsArea+"<br>");
                content.push("层数："+list[i].hsLayer+"<br>");
                content.push("朝向："+list[i].hsOriented+"<br>");
                var str = (list[i].rtlfRentaltype == 0?'短租':'长租');
                content.push("出租类型："+str+"<br>");
                content.push("户型："+list[i].hsType+"<br>");
                content.push("地址："+list[i].hsCity+list[i].hsDistrict +list[i].hsHousingestate
                    + list[i].hsAddress+"<br>");
                content.push("<a href='' >"+"更详细信息"+"</a><br>");

                text.content = content.join("") ;
                text.on('mouseover', markerClick);
                text.on('mouseout', closeInfoWindow);

                markers.push(text);
            }
        }
        overlayGroups = new AMap.OverlayGroup(markers);
        map.add(overlayGroups);
        //map.remove(overlayGroups);
    }

    var infoWindow = new AMap.InfoWindow({
        //isCustom: true,  //使用自定义窗体
        offset: new AMap.Pixel(0,-15)
    });

    //打开信息窗体
    function markerClick(e) {
        infoWindow.setContent(e.target.content);
        infoWindow.open(map, e.target.getPosition());
    }
    //
    //关闭信息窗体
    function closeInfoWindow() {
        map.clearInfoWindow();
    }

    //监听地图缩放级别
    map.on('zoomchange', function() {
        console.log("当前缩放级别："+map.getZoom());
        var nowzoom = map.getZoom();
        if(nowzoom <= 11){
            map.remove(overlayGroups);
            markers = [];
        }
        if(nowzoom > 13){

        }
    });

    //
    map.on('click', getDataClick);

    function getDataClick() {
        if(confirm("输入数据？"))
        {
            for(var i =0;i<1;i++){
                AMap.service(["AMap.PlaceSearch"], function() {
                    //构造地点查询类
                    var placeSearch = new AMap.PlaceSearch({
                     type: "宾馆", // 兴趣点类别
                        pageSize: 50, // 单页显示结果条数
                        pageIndex: i, // 页码
                        city: "越秀区", // 兴趣点城市
                        citylimit: true,  //是否强制限制在设置的城市内搜索
                    });

                    //alert(cyc)
                    placeSearch.search("宾馆", function(status, result) {
                        console.log(result);//result.poiList.pois.length
                        for(var j = 0;j<1;j++){
                            var marker = new AMap.Marker({
                                position: [result.poiList.pois[j].location.lng,
                                    result.poiList.pois[j].location.lat],
                                map: map
                            });
                            $.ajax({
                                url:'http://localhost:8080/admin/user/mapDataTest',//地址
                                data:{
                                    address:result.poiList.pois[j].address,
                                    lng:result.poiList.pois[j].location.lng,
                                    lat:result.poiList.pois[j].location.lat,
                                },
                                dataType: "json",
                                type:'POST',//类型
                                //请求成功
                                success:function(data){
                                    console.log("chenggong");
                                }
                            })
                        }

                    });
                });
            }
        }
    }
</script>
</body>
</html>